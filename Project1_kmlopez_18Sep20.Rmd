---
title: "Project 1 - Karen Lopez"
date: "September 18, 2020"
output:
  rmarkdown::github_document:
    toc: true
knit: (function(input, ...){
  rmarkdown::render(
    input,
    output_file="README.md",
    envir=globalenv()
  )})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Reading and Summarizing Data from the NHL's API
This vignette was compiled to provide detailed instructions on reading and summarizing data from the National Hockey League's, or NHL's, API using R code.

## Required Packages
First, install and read in the necessary packages, as shown below. Packages only need to be installed once, but code is included in comment.  
```{r packages, message=FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(httr)
library(jsonlite)
library(dplyr)
library(knitr)
```

## Make Contact and Get Data
This code contains functions that will contact the [NHL records API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) and [NHL stat API](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md), and return parsed, well-formatted data.  

### Franchise API
```{r franchiseAPI, message=FALSE}
#function that creates the url for the records API
getUrl <- function(input){
  baseUrl <- "https://records.nhl.com/site/api/franchise"
  table <- input
  fullURL <- paste0(baseUrl, table) #create url
}

franchise <- function(){
  franchiseAPI <- GET(getUrl(NULL)) #get url to grab data
  franchiseAPI #check connection
  
  franchiseText <- content(franchiseAPI, "text") #convert to JSON text form
  #franchiseText #check dataset
  franchiseList <- fromJSON(franchiseText, flatten=TRUE) #convert form
  franchiseDF <- as.data.frame(franchiseList) #convert to df, adds .data to col names
  #franchiseDF #check dataset
  colnames(franchiseDF) <- c("id", "firstSeasonId", "lastSeasonId", "mostRecentTeamId", "teamCommonName", "teamPlaceName", "total") #rename columns
  
  return(franchiseDF)
}
franchiseData <- franchise() #save data frame object (used in other functions later)
#print(kable(franchiseData))

teamTotals <- function(){
  teamAPI <- GET(getUrl("-team-totals"))
  teamAPI #check connection
  
  teamText <- content(teamAPI, "text") #convert to JSON text form
  #teamText #check dataset
  teamList <- fromJSON(teamText, flatten=TRUE) #convert form
  teamDF <- as.data.frame(teamList)
  #teamList #check dataset
  colnames(teamDF) <- c("id", "activeFranchise", "firstSeasonId", "franchiseId", "gameTypeId", "gamesPlayed", "goalsAgainst", "goalsFor", "homeLosses", "homeOvertimeLosses", "homeTies", "homeWins", "lastSeasonId", "losses","overtimeLosses", "penaltyMinutes", "pointPctg", "points", "roadLosses", "roadOvertimeLosses", "roadTies", "roadWins", "shootoutLosses", "shootoutWins",  "shutouts", "teamId", "teamName", "ties", "triCode", "wins", "total")
  
  return(teamDF)
}
#teamsT <- teamTotals() #test that function works
#print(kable(teamsT))

#function that return numeric team ID when supplied with team name
getID <- function(teamName){
  teamData <- data.frame()
  teamID <- NULL
  if(teamName %in% franchiseData$teamCommonName){
    #print(paste0(teamName, " is common name")) #test code
    teamData <- franchiseData %>% filter(franchiseData$teamCommonName==teamName)
    teamID <- teamData$id
  } else if(teamName %in% franchiseData$teamPlaceName){
    #print(paste0(teamName, " is place name")) #test code
    teamData <- franchiseData %>% filter(franchiseData$teamPlaceName==teamName)
    teamID <- teamData$id
  } else {print("Please enter valid team name.")}
  return(teamID)
}

seasonRecords <- function(ID){
  url <- ""
  if(is.numeric(ID)){
    url <- paste0("-season-records?cayenneExp=franchiseId=", ID)
  } else if(is.character(ID)){
    ID = getID(ID)
    url <- paste0("-season-records?cayenneExp=franchiseId=", ID)
  }
  #url = "-season-records" #view the 38 teams that have stats
  #print(url) #test code
  seasonAPI <- GET(getUrl(url))
  seasonAPI #check connection
  
  seasonText <- content(seasonAPI, "text") #convert to JSON text form
  seasonText #check dataset
  seasonList <- fromJSON(seasonText, flatten=TRUE) #convert form
  #seasonList #check dataset
  seasonDF <- as.data.frame(seasonList)
  #seasonList #check dataset
  colnames(seasonDF) <- c("id", "fewestGoals", "fewestGoalsAgainst", "fewestGoalsAgainstSeasons", "fewestGoalsSeasons", "fewestLosses", "fewestLossesSeasons", "fewestPoints", "fewestPointsSeasons", "fewestTies", "fewestTiesSeasons", "fewestWins", "fewestWinsSeasons", "franchiseId", "franchiseName", "homeLossStreak", "homeLossStreakDates", "homePointStreak", "homePointStreakDates", "homeWinStreak", "homeWinStreakDates", "homeWinlessStreak", "homeWinlessStreakDates", "lossStreak", "lossStreakDates", "mostGameGoals", "mostGameGoalsDates", "mostGoals", "mostGoalsAgainst", "mostGoalsAgainstSeasons", "mostGoalsSeasons", "mostLosses", "mostLossesSeasons", "mostPenaltyMinutes", "mostPenaltyMinutesSeasons", "mostPoints", "mostPointsSeasons", "mostShutouts", "mostShutoutsSeasons", "mostTies", "mostTiesSeasons", "mostWins", "mostWinsSeasons", "pointStreak", "pointStreakDates", "roadLossStreak", "roadLossStreakDates", "roadPointStreak", "roadPointStreakDates", "roadWinStreak", "roadWinStreakDates", "roadWinlessStreak", "roadWinlessStreakDates", "winStreak", "winStreakDates", "winlessStreak", "winlessStreakDates") #change df col names

  return(seasonDF)
}
#seasonRecord <- seasonRecords("Carolina") #test that function works
#print(kable(seasonRecord))

goalieRecords <- function(ID){
  url <- ""
  if(is.numeric(ID)){
    url <- paste0("-goalie-records?cayenneExp=franchiseId=", ID)
  } else if(is.character(ID)){
    ID = getID(ID)
    url <- paste0("-goalie-records?cayenneExp=franchiseId=", ID)
  }
  #url = "-goalie-records" #view the goalies that have stats
  #print(url) #test code
  goalieAPI <- GET(getUrl(url))
  goalieAPI #check connection
  
  goalieText <- content(goalieAPI, "text") #convert to JSON text form
  goalieText #check dataset
  goalieList <- fromJSON(goalieText, flatten=TRUE) #convert form
  goalieList #check dataset

  goalieDF <- as.data.frame(goalieList)
  #goalieList #check dataset
  colnames(goalieDF) <- c("id", "activePlayer", "firstName", "franchiseId", "franchiseName", "gameTypeId", "gamesPlayed", "lastName", "losses", "mostGoalsAgainstDates", "mostGoalsAgainstOneGame", "mostSavesDates", "mostSavesOneGame", "mostShotsAgainstDates", "mostShotsAgainstOneGame", "mostShutoutsOneSeason", "mostShutoutsSeasonIds", "mostWinsOneSeason", "mostWinsSeasonIds", "overtimeLosses", "playerId", "positionCode", "rookieGamesPlayed", "rookieShutouts", "rookieWins", "seasons", "shutouts", "ties", "dwins", "total") #change df col names

  return(goalieDF)
}
#goalieRecord <- goalieRecords("Carolina") #test that function works
#print(kable(goalieRecord))

skaterRecords <- function(ID){
  url <- ""
  if(is.numeric(ID)){
    url <- paste0("-skater-records?cayenneExp=franchiseId=", ID)
  } else if(is.character(ID)){
    ID = getID(ID)
    url <- paste0("-skater-records?cayenneExp=franchiseId=", ID)
  }
  
  #url = "-skater-records" #view the skaters that have stats
  #print(url) #test code
  skaterAPI <- GET(getUrl(url))
  #skaterAPI #check connection

  skaterText <- content(skaterAPI, "text") #convert to JSON text form
  #skaterText #check dataset
  skaterList <- fromJSON(skaterText, flatten=TRUE) #convert form
  #skaterList #check dataset
  
  skaterDF <- as.data.frame(skaterList)
  #skaterList #check dataset
  colnames(skaterDF) <- c("id", "activePlayer", "assists", "firstName", "franchiseId", "franchiseName", "gameTypeId", "gamesPlayed", "goals", "lastName", "mostAssistsGameDates", "mostAssistsOneGame", "mostAssistsOneSeason", "mostAssistsSeasonIds", "mostGoalsGameDates", "mostGoalsOneGame", "mostGoalsOneSeason", "mostGoalsSeasonIds", "mostPenaltyMinutesOneSeason", "mostPenaltyMinutesSeasonIds", "mostPointsGameDates", "mostPointsOneGame", "mostPointsOneSeason", "mostPointsSeasonIds", "penaltyMinutes", "playerId", "points", "positionCode", "rookiePoints", "seasons", "total") #change df col names

  return(skaterDF)
}
#skaterRecord <- skaterRecords(9) #test that function works
#print(kable(skaterRecord))
```
  
### Stats API  
The user is required to input a team ID or name and modifier to access the desired data. This string input format isn't ideal, but is corrected in the wrapper function.  
Input guide for modifiers, copied from API website:  
  -?expand=team.roster Shows roster of active players for the specified team  
  -?expand=person.names Same as above, but gives less info  
  -?expand=team.schedule.next Returns details of the upcoming game for a team  
  -?expand=team.schedule.previous Same as above but for the last game played  
  -?expand=team.stats Returns the teams stats for the season  
  -?expand=team.roster&season=20142015 Adding the season identifier shows the roster for that season  
  -?teamId=4,5,29 Can string team id together to get multiple teams  
```{r statsAPI, message=FALSE}
#from stats API
teams <- function(ID, input){
  url <- ""
  if(is.numeric(ID)){
    url <- paste0("https://statsapi.web.nhl.com/api/v1/teams/", ID, "/", input)
  } else if(is.character(ID)){
    ID = getID(ID)
    url <- paste0("https://statsapi.web.nhl.com/api/v1/teams/", ID, "/", input)
  }
  
  #print(url)
  teamsAPI <- GET(url)
  teamsAPI #check connection

  teamsText <- content(teamsAPI, "text") #convert to JSON text form
  teamsText #check dataset
  teamsList <- fromJSON(teamsText, flatten=TRUE) #convert form
  #teamsList #check dataset
  
  teamsDF <- as.data.frame(teamsList)
  #teamsList #check dataset
  #colnames(teamsDF) <- c() #change df col names

  return(teamsDF)
}
#teamsRecord <- teams(12,"?expand=person.names") #test that function works
#print(kable(teamsRecord))

#teamsRecord2 <- teams(54,"?expand=team.schedule.next") #test that function works
#print(kable(teamsRecord2))

#API returns the same team information table across the different modifiers with nested data frame(s) that contain the modifier data. On the discussion board, the instructor noted we can print the output as is and that we shouldn't worry about the last modifier, so I omitted modifier 13 (?stats=statsSingleSeasonPlayoffs).

#first 7 of 8 modifiers list:https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md#teams  
```

## Wrapper Function
This wrapper function allows the user to access any of the API endpoints and modifiers included in the above code. The user must input the endpoint and team ID or name, where team input is applicable. The endpoints have been coded by numerbers, making user input more friendly.  
  
Endpoint input guide, number 1-5 are from the Records API and numbers 6-12 are from the Stats API:
  -1: franchise information for all teams  
  -2: team totals for all teams  
  -3: season records for a team (must specify team ID or name)  
  -4: goalie records for a team (must specify team ID or name)  
  -5: skater records for a team (must specify team ID or name)  
  -6: team roster of active players for a team (must specify team ID or name)  
  -7: active player names for a team (must specify team ID or name)  
  -8: upcoming game for a team (must specify team ID or name)  
  -9: last game played for a team (must specify team ID or name)  
  -10: season stats for a team (must specify team ID or name)  
  -11: roster by season for a team (must specify team ID or name)  
  -12: franchise information for multiple teams (must specify team IDs or names)  

```{r wrapperFcn}
accessAPI <- function(endpoint, team=NULL){
  outputDF <- NULL #create output object
  
  #check if team name is character or valid number, get numeric ID if character
  if(is.null(team)){
  } else if(is.character(team)){
    team = getID(team)
  } else if(!is.numeric(team)){
    print("Please enter valid team name or ID.")
  }
  
  #check if endpoint is valid, get url based on endpoint input
  if(endpoint==1){
    outputDF <- franchise()
  } else if(endpoint==2){
    outputDF <- teamTotals()
  } else if(endpoint==3){
    outputDF <- seasonRecords(team)
  } else if(endpoint==4){
    outputDF <- goalieRecords(team)
  } else if(endpoint==5){
    outputDF <- skaterRecords(team)
  } else if(endpoint==6){
    outputDF <- teams(team, "?expand=team.roster")
  } else if(endpoint==7){
    outputDF <- teams(team, "?expand=person.names")
  } else if(endpoint==8){
    outputDF <- teams(team, "?expand=team.schedule.next")
  } else if(endpoint==9){
    outputDF <- teams(team, "?expand=team.schedule.previous")
  } else if(endpoint==10){
    outputDF <- teams(team, "?expand=team.stats")
  } else if(endpoint==11){
    outputDF <- teams(team, "?expand=team.roster&season=20142015")
  } else if(endpoint==12){
    outputDF <- teams(team, "?teamId=4,5,29")
  } else {
    print("Please enter a valid number endpoint or modifier between 1 and 13.")
  }
return(outputDF)
}
#test code, all work
#franchise1 <- accessAPI(1)
#print(head(franchise1))

#goalie1<- accessAPI(4, "Carolina")
#print(head(goalie1))

#roster1 <- accessAPI(6, team=12)
#print(roster1)
```
## Exploratory Analysis
Once you have the functions to query the data, you should perform a basic exploratory data analysis. Not all things reported need to show something interesting or meaningful (i.e. graphs that show no relationship are fine) but you should discuss each graph (if you don’t know hockey, that is ok - simply discuss the graphs and summaries as best you can). A few requirements are below:  
```{r join, message=FALSE}
#join goalie records and skater records for Boston Bruins
goaliesB <- accessAPI(4, team="Boston")
skatersB <- accessAPI(5, team="Boston")
playersB <- bind_rows(goaliesB, skatersB)
combo <- bind_rows(head(playersB),tail(playersB)) #join first 6 and low 4 rows because viewing entire data set is too much for the knit document to create
print(kable(combo))

```

```{r newVariables, message=FALSE}
#add ratio of most goals against versus saves for the Carolina Hurricanse
goaliesC <- accessAPI(4, "Carolina")
goaliesC <- goaliesC %>% mutate(ratio=mostGoalsAgainstOneGame/mostSavesOneGame)
print(kable(head(goaliesC)))

#add column to Atlanta Thrashers for the mascot name
rosterA <- accessAPI(6, team=11)
rosterA <- rosterA %>% mutate(mascot="Thrash")
print(kable(rosterA))
```

```{r contingencyTables, message=FALSE}
#view game type counts from team totals
#1 is pre-season, 2 is regular season, 3 is post-season")
teamTots <- accessAPI(2)
table(kable(teamTots$gameTypeId))

#view active(1) vs inactive(0) franchises from team totals
table(kable(teamTots$activeFranchise))

#view how many goalies played in the same number of games for Boston Bruins
table(kable(goaliesB$gamesPlayed))
```

```{r numSummeries, message=FALSE}
#You should create numerical summaries for some quantitative variables at each setting of some of your categorical variables
#summary of wins for all franchises
print(summary(teamTots$wins))

#view correlation between losses anf games played by Carolina Hurricanes goalies
print(cor(goaliesC$losses, goaliesC$gamesPlayed))

#view average wins and losses by franchise id
teamTots %>% group_by(teamTots$franchiseId) %>% summarise(avgWins=mean(wins), avgLosses=mean(losses))
```

```{r plots, eval=FALSE, include=FALSE, message=FALSE}
#You should create at least five plots utilizing coloring, grouping, etc. All plots should have nice labels and titles.
#You should have at least one bar plot, one histogram, one box plot, and one scatter plot

```
